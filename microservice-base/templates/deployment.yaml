{{- range .Values.apps }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .name }}-{{ .environment }}
  labels:
    app: {{ .name }}-{{ .environment }}
    group: {{ .group }}
spec:
  replicas: {{ .replicaCount }}
  selector:
    matchLabels:
      app: {{ .name }}-{{ .environment }}
  template:
    metadata:
      labels:
        app: {{ .name }}-{{ .environment }}
        group: {{ .group }}
      annotations:
          rollme: {{ randAlphaNum 5 | quote }}
          vault.hashicorp.com/agent-inject: 'true'
          vault.hashicorp.com/role: '{{ .name }}-{{ .environment }}'
          vault.hashicorp.com/agent-inject-secret-secrets.txt: 'services/{{ .environment }}/{{ .name }}'
          vault.hashicorp.com/agent-inject-template-secrets.txt: |
            {{ "{{" }}- with secret "services/{{ .environment }}/{{ .name }}" {{ "}}" }}
            {{ "{{" }}- range $k, $v := .Data.data {{ "}}" }}
            export {{ "{{" }} $k {{ "}}" }}="{{ "{{" }} $v {{ "}}" }}"
            {{ "{{" }}- end {{ "}}" }}
            {{ "{{" }}- end {{ "}}" }}
    spec:
      serviceAccountName: {{ .name }}-{{ .environment }}
      containers:
        - name: {{ .name }}-{{ .environment }}
          image: {{ .container.image.repository }}:{{ .container.image.tag }}
          ports:
            - containerPort: {{ .container.port }}
          env:
            - name: KUBERNETES
              value: 'true'
            - name: APP_ENV
              value: {{ .environment }}
      {{- with .container.imagePullSecrets }}
        imagePullSecrets:
          {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
